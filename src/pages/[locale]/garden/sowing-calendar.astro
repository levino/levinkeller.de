---
import { getCollection } from 'astro:content'
import { MONTHS_DE } from '@levino/shipyard-base'
import Layout from '@levino/shipyard-base/layouts/Page.astro'
import type { GetStaticPaths } from 'astro'
import {
  buildTrackedCalendar,
  getISOWeek,
  type SowingLogEntry,
} from '@/tools/calendarWeeks'

export const getStaticPaths = (() => {
  return [
    {
      params: {
        locale: 'de',
      },
    },
  ]
}) satisfies GetStaticPaths

const year = 2026
const currentWeek = getISOWeek(new Date())

const vegetables = await getCollection('vegetables')
const sowingLogs = await getCollection('sowingLog')

// Find log for current year
const yearLog = sowingLogs.find((log) => log.id === String(year))
const logEntries: SowingLogEntry[] = (yearLog?.data.entries ?? []).map((e) => ({
  vegetable: typeof e.vegetable === 'object' ? e.vegetable.id : e.vegetable,
  date: e.date,
}))

const { weekMap: calendarWeekMap, missedVegetables } = buildTrackedCalendar(
  vegetables,
  logEntries,
  currentWeek,
  year
)

const sortedWeeks = [...calendarWeekMap.keys()].sort((a, b) => a - b)

// Map KW to approximate month name for grouping headers
const kwToMonth = (kw: number): string => {
  const date = new Date(year, 0, 1 + (kw - 1) * 7)
  return MONTHS_DE[date.getMonth()]
}
---

<Layout>
  <div class="container mx-auto max-w-4xl px-4">
    <h1 class="m-4 text-center text-2xl font-bold">
      Aussaatkalender {year}
    </h1>
    <p class="mb-2 text-center text-sm opacity-70">
      Wochenweise Übersicht — aktuelle KW: {currentWeek}
    </p>
    <div class="mb-6 flex flex-wrap justify-center gap-3 text-xs">
      <span class="flex items-center gap-1">
        <span class="inline-block h-3 w-3 rounded-full bg-success"></span> Erledigt
      </span>
      <span class="flex items-center gap-1">
        <span class="inline-block h-3 w-3 rounded-full bg-info"></span> Jetzt
        möglich
      </span>
      <span class="flex items-center gap-1">
        <span class="inline-block h-3 w-3 rounded-full bg-base-300"></span> Geplant
      </span>
    </div>

    {missedVegetables.length > 0 && (
      <div class="mb-6 rounded-lg bg-base-200 p-4">
        <h2 class="mb-2 text-sm font-medium opacity-70">
          Dieses Jahr nicht ausgesät
        </h2>
        <div class="flex flex-wrap gap-2">
          {missedVegetables.map((veg) => (
            <a
              href={`./vegetables/${veg.id}`}
              class="badge badge-outline badge-sm opacity-60 hover:opacity-100"
            >
              {veg.name}
            </a>
          ))}
        </div>
      </div>
    )}

    <div class="space-y-1">
      {
        sortedWeeks.map((kw, idx) => {
          const entries = calendarWeekMap.get(kw)!
          const month = kwToMonth(kw)
          const prevMonth = idx > 0 ? kwToMonth(sortedWeeks[idx - 1]) : ''
          const showMonthHeader = month !== prevMonth
          const isCurrentWeek = kw === currentWeek
          return (
            <>
              {showMonthHeader && (
                <div class="mt-6 mb-2 border-b-2 border-primary pb-1">
                  <h2 class="text-lg font-semibold text-primary">{month}</h2>
                </div>
              )}
              <div
                class:list={[
                  'collapse collapse-arrow',
                  isCurrentWeek
                    ? 'bg-primary/10 border-2 border-primary'
                    : 'bg-base-200',
                ]}
              >
                <input
                  type="checkbox"
                  checked={isCurrentWeek || kw > currentWeek - 2}
                />
                <div class="collapse-title font-medium">
                  KW {kw}
                  {isCurrentWeek && (
                    <span class="badge badge-sm badge-primary ml-2">
                      aktuelle Woche
                    </span>
                  )}
                  <span class="ml-2 text-sm opacity-60">
                    ({entries.length} Gemüse)
                  </span>
                </div>
                <div class="collapse-content">
                  <ul class="list-none space-y-1">
                    {entries.map((entry) => (
                      <li
                        class:list={[
                          'flex items-center gap-2 rounded px-2 py-1',
                          entry.status === 'done' && 'bg-success/10',
                          entry.status === 'available' && 'bg-info/5',
                        ]}
                      >
                        {entry.status === 'done' && (
                          <span class="text-success" title="Erledigt">
                            &#10003;
                          </span>
                        )}
                        {entry.status === 'available' && (
                          <span
                            class="text-info text-sm"
                            title="Jetzt möglich"
                          >
                            &#9679;
                          </span>
                        )}
                        <a
                          href={`./vegetables/${entry.id}`}
                          class:list={[
                            'link link-hover',
                            entry.status === 'done' &&
                              'line-through opacity-60',
                          ]}
                        >
                          {entry.name}
                        </a>
                        {entry.succession > 1 && (
                          <span class="badge badge-sm badge-outline">
                            {entry.succession}. Aussaat
                          </span>
                        )}
                        {entry.underCover && (
                          <span class="badge badge-sm badge-info">
                            geschützt
                          </span>
                        )}
                        {entry.overwintering && (
                          <span class="badge badge-sm badge-warning">
                            Überwinterung
                          </span>
                        )}
                        {entry.note && (
                          <span class="badge badge-sm badge-ghost">
                            {entry.note}
                          </span>
                        )}
                        {entry.status === 'done' && entry.actualDate && (
                          <span class="text-xs opacity-50">
                            (gesät {entry.actualDate}, KW {entry.actualWeek})
                          </span>
                        )}
                        {entry.status === 'available' && (
                          <span class="text-xs opacity-50">
                            (noch möglich bis KW {entry.lastPossibleWeek})
                          </span>
                        )}
                        {entry.status === 'upcoming' &&
                          entry.plannedWeek !== kw && (
                            <span class="text-xs opacity-50">
                              (verschoben von KW {entry.plannedWeek})
                            </span>
                          )}
                      </li>
                    ))}
                  </ul>
                </div>
              </div>
            </>
          )
        })
      }
    </div>
  </div>
</Layout>
