---
import { getCollection } from 'astro:content'
import { MONTHS_DE } from '@levino/shipyard-base'
import Layout from '@levino/shipyard-base/layouts/Page.astro'
import type { GetStaticPaths } from 'astro'
import {
  buildTrackedCalendar,
  getISOWeek,
  type SowingCalendarEntry,
  type SowingLogEntry,
} from '@/tools/calendarWeeks'

export const getStaticPaths = (() => {
  return [
    {
      params: {
        locale: 'de',
      },
    },
  ]
}) satisfies GetStaticPaths

const year = 2026
const currentWeek = getISOWeek(new Date())

const vegetables = await getCollection('vegetables')
const sowingLogs = await getCollection('sowingLog')

// Find log for current year
const yearLog = sowingLogs.find((log) => log.id === String(year))
const logEntries: SowingLogEntry[] = (yearLog?.data.entries ?? []).map((e) => ({
  vegetable: typeof e.vegetable === 'object' ? e.vegetable.id : e.vegetable,
  date: e.date,
}))

const { weekMap: calendarWeekMap, missedVegetables } = buildTrackedCalendar(
  vegetables,
  logEntries,
  currentWeek
)

const sortedWeeks = [...calendarWeekMap.keys()].sort((a, b) => a - b)

// Map KW to approximate month name for grouping headers
const kwToMonth = (kw: number): string => {
  const date = new Date(year, 0, 1 + (kw - 1) * 7)
  return MONTHS_DE[date.getMonth()]
}

// Sort entries by urgency: fewest remaining weeks first (most urgent = top)
const sortByUrgency = (entries: SowingCalendarEntry[]) => {
  return [...entries].sort((a, b) => {
    // Done entries always last
    if (a.status === 'done' && b.status !== 'done') return 1
    if (a.status !== 'done' && b.status === 'done') return -1
    // Sort by remaining weeks (ascending = most urgent first)
    const remainA = a.lastPossibleWeek - currentWeek
    const remainB = b.lastPossibleWeek - currentWeek
    return remainA - remainB
  })
}

// Urgency color: dark green = last chance, light green = plenty of time
const urgencyColor = (entry: SowingCalendarEntry): string => {
  if (entry.status === 'done') return ''
  const remaining = entry.lastPossibleWeek - currentWeek
  if (remaining <= 1) return 'border-l-4 border-green-800 bg-green-100'
  if (remaining <= 4) return 'border-l-4 border-green-600 bg-green-50'
  return 'border-l-4 border-green-300 bg-green-50/50'
}

// Split weeks into current, past, and future
const currentWeekEntries = calendarWeekMap.get(currentWeek)
const pastWeeks = sortedWeeks.filter((kw) => kw < currentWeek)
const futureWeeks = sortedWeeks.filter((kw) => kw > currentWeek)
---

<Layout>
  <div class="container mx-auto max-w-4xl px-4">
    <h1 class="m-4 text-center text-2xl font-bold">
      Aussaatkalender {year}
    </h1>
    <p class="mb-2 text-center text-sm opacity-70">
      Wochenweise Übersicht — aktuelle KW: {currentWeek}
    </p>
    <div class="mb-6 flex flex-wrap justify-center gap-3 text-xs">
      <span class="flex items-center gap-1">
        <span class="inline-block h-3 w-3 rounded-full bg-success"></span> Erledigt
      </span>
      <span class="flex items-center gap-1">
        <span class="inline-block h-3 w-3 border-l-4 border-green-800 bg-green-100 h-3 w-6"></span> Letzte
        Chance
      </span>
      <span class="flex items-center gap-1">
        <span class="inline-block h-3 w-3 border-l-4 border-green-300 bg-green-50/50 h-3 w-6"></span> Noch
        Zeit
      </span>
    </div>

    {missedVegetables.length > 0 && (
      <div class="mb-6 rounded-lg bg-base-200 p-4">
        <h2 class="mb-2 text-sm font-medium opacity-70">
          Dieses Jahr nicht ausgesät
        </h2>
        <div class="flex flex-wrap gap-2">
          {missedVegetables.map((veg) => (
            <a
              href={`./vegetables/${veg.id}`}
              class="badge badge-outline badge-sm opacity-60 hover:opacity-100"
            >
              {veg.name}
            </a>
          ))}
        </div>
      </div>
    )}

    {/* Current week — always visible and expanded */}
    {currentWeekEntries && (
      <div class="mb-6">
        <h2 class="mb-3 text-lg font-semibold">
          Diese Woche (KW {currentWeek})
        </h2>
        <ul class="list-none space-y-1">
          {sortByUrgency(currentWeekEntries).map((entry) => (
            <li
              class:list={[
                'flex items-center gap-2 rounded px-3 py-2',
                entry.status === 'done' ? 'bg-success/10' : urgencyColor(entry),
              ]}
            >
              {entry.status === 'done' && (
                <span class="text-success" title="Erledigt">
                  &#10003;
                </span>
              )}
              <a
                href={`./vegetables/${entry.id}`}
                class:list={[
                  'link link-hover',
                  entry.status === 'done' && 'line-through opacity-60',
                ]}
              >
                {entry.name}
              </a>
              {entry.succession > 1 && (
                <span class="badge badge-sm badge-outline">
                  {entry.succession}. Aussaat
                </span>
              )}
              {entry.underCover && (
                <span class="badge badge-sm badge-info">geschützt</span>
              )}
              {entry.overwintering && (
                <span class="badge badge-sm badge-warning">Überwinterung</span>
              )}
              {entry.note && (
                <span class="badge badge-sm badge-ghost">{entry.note}</span>
              )}
              {entry.status === 'done' && entry.actualDate && (
                <span class="text-xs opacity-50">
                  (gesät {entry.actualDate}, KW {entry.actualWeek})
                </span>
              )}
              {entry.status !== 'done' && entry.lastPossibleWeek - currentWeek < 2 && (
                <span class="text-xs font-medium text-green-800">
                  Letzte Chance
                </span>
              )}
              {entry.status !== 'done' && entry.lastPossibleWeek - currentWeek > 1 && (
                <span class="text-xs opacity-50">
                  (noch bis KW {entry.lastPossibleWeek})
                </span>
              )}
            </li>
          ))}
        </ul>
      </div>
    )}

    {/* Past weeks — collapsed */}
    {pastWeeks.length > 0 && (
      <details class="mb-4">
        <summary class="cursor-pointer text-sm font-medium opacity-60 hover:opacity-100">
          Vergangene Wochen anzeigen ({pastWeeks.length})
        </summary>
        <div class="mt-2 space-y-1">
          {pastWeeks.map((kw, idx) => {
            const entries = calendarWeekMap.get(kw)!
            const month = kwToMonth(kw)
            const prevMonth = idx > 0 ? kwToMonth(pastWeeks[idx - 1]) : ''
            const showMonthHeader = month !== prevMonth
            return (
              <>
                {showMonthHeader && (
                  <div class="mt-4 mb-2 border-b pb-1">
                    <h3 class="text-base font-semibold opacity-70">{month}</h3>
                  </div>
                )}
                <div class="collapse collapse-arrow bg-base-200">
                  <input type="checkbox" />
                  <div class="collapse-title font-medium text-sm">
                    KW {kw}
                    <span class="ml-2 text-sm opacity-60">
                      ({entries.length} Gemüse)
                    </span>
                  </div>
                  <div class="collapse-content">
                    <ul class="list-none space-y-1">
                      {entries.map((entry) => (
                        <li class="flex items-center gap-2 rounded px-2 py-1 bg-success/10">
                          <span class="text-success" title="Erledigt">&#10003;</span>
                          <a
                            href={`./vegetables/${entry.id}`}
                            class="link link-hover line-through opacity-60"
                          >
                            {entry.name}
                          </a>
                          {entry.actualDate && (
                            <span class="text-xs opacity-50">
                              (gesät {entry.actualDate})
                            </span>
                          )}
                        </li>
                      ))}
                    </ul>
                  </div>
                </div>
              </>
            )
          })}
        </div>
      </details>
    )}

    {/* Future weeks — hidden behind toggle */}
    {futureWeeks.length > 0 && (
      <details class="mt-4">
        <summary class="cursor-pointer text-sm font-medium opacity-60 hover:opacity-100">
          Weitere Wochen anzeigen ({futureWeeks.length})
        </summary>
        <div class="mt-2 space-y-1">
          {futureWeeks.map((kw, idx) => {
            const entries = calendarWeekMap.get(kw)!
            const month = kwToMonth(kw)
            const prevMonth = idx > 0 ? kwToMonth(futureWeeks[idx - 1]) : ''
            const showMonthHeader = month !== prevMonth
            return (
              <>
                {showMonthHeader && (
                  <div class="mt-4 mb-2 border-b pb-1">
                    <h3 class="text-base font-semibold opacity-70">{month}</h3>
                  </div>
                )}
                <div class="collapse collapse-arrow bg-base-200">
                  <input type="checkbox" />
                  <div class="collapse-title font-medium text-sm">
                    KW {kw}
                    <span class="ml-2 text-sm opacity-60">
                      ({entries.length} Gemüse)
                    </span>
                  </div>
                  <div class="collapse-content">
                    <ul class="list-none space-y-1">
                      {sortByUrgency(entries).map((entry) => (
                        <li
                          class:list={[
                            'flex items-center gap-2 rounded px-2 py-1',
                            entry.status === 'done'
                              ? 'bg-success/10'
                              : urgencyColor(entry),
                          ]}
                        >
                          {entry.status === 'done' && (
                            <span class="text-success" title="Erledigt">&#10003;</span>
                          )}
                          <a
                            href={`./vegetables/${entry.id}`}
                            class:list={[
                              'link link-hover',
                              entry.status === 'done' && 'line-through opacity-60',
                            ]}
                          >
                            {entry.name}
                          </a>
                          {entry.succession > 1 && (
                            <span class="badge badge-sm badge-outline">
                              {entry.succession}. Aussaat
                            </span>
                          )}
                          {entry.underCover && (
                            <span class="badge badge-sm badge-info">geschützt</span>
                          )}
                          {entry.overwintering && (
                            <span class="badge badge-sm badge-warning">Überwinterung</span>
                          )}
                          {entry.note && (
                            <span class="badge badge-sm badge-ghost">{entry.note}</span>
                          )}
                          {entry.status !== 'done' && (
                            <span class="text-xs opacity-50">
                              (noch bis KW {entry.lastPossibleWeek})
                            </span>
                          )}
                        </li>
                      ))}
                    </ul>
                  </div>
                </div>
              </>
            )
          })}
        </div>
      </details>
    )}
  </div>
</Layout>
